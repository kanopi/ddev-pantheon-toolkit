#!/bin/bash

## Description: Add a supporting organization to Pantheon sites
## Usage: add-org [flags] <org-name> <supporting-org>
## Example: ddev add-org my-org supporting-agency\nddev add-org --upstream 8a129104-9ae2-4700-8c23-1234567890ab my-org supporting-agency\nddev add-org --dry-run --csv results.csv my-org supporting-agency
## Flags: [{"Name":"upstream","Shorthand":"u","Usage":"Filter by upstream ID (optional, processes all sites if not specified)","Type":"string"},{"Name":"dry-run","Shorthand":"d","Usage":"Perform a dry run without making changes","Type":"bool"},{"Name":"csv","Shorthand":"c","Usage":"Export results to CSV file","Type":"string"},{"Name":"verbose","Shorthand":"v","Usage":"Enable verbose output","Type":"bool"}]
## ExecRaw: true
#ddev-generated

# Configuration variables
ORG_NAME=""
UPSTREAM_ID=""  # Now optional
SUPPORTING_ORG=""
DRY_RUN=false
EXPORT_CSV=false
CSV_FILE=""
VERBOSE=false
LOG_FILE="pantheon_org_update_$(date +%Y%m%d_%H%M%S).log"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $message" >> "$LOG_FILE"
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -u|--upstream)
                UPSTREAM_ID="$2"
                shift 2
                ;;
            -d|--dry-run)
                DRY_RUN=true
                shift
                ;;
            -c|--csv)
                EXPORT_CSV=true
                CSV_FILE="$2"
                shift 2
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            *)
                if [ -z "$ORG_NAME" ]; then
                    ORG_NAME="$1"
                elif [ -z "$SUPPORTING_ORG" ]; then
                    SUPPORTING_ORG="$1"
                else
                    print_message "$RED" "Error: Too many arguments"
                    exit 1
                fi
                shift
                ;;
        esac
    done
}

# Validate prerequisites
validate_prerequisites() {
    # Check if all required arguments are provided
    if [ -z "$ORG_NAME" ] || [ -z "$SUPPORTING_ORG" ]; then
        print_message "$RED" "Error: Missing required arguments: <org-name> <supporting-org>"
        exit 1
    fi

    # Check if terminus is installed
    if ! command -v terminus &> /dev/null; then
        print_message "$RED" "Error: Terminus is not installed or not in PATH"
        exit 1
    fi

    # Check if jq is installed
    if ! command -v jq &> /dev/null; then
        print_message "$RED" "Error: jq is not installed. Please install jq to run this script"
        exit 1
    fi

    # Check if user is authenticated
    if ! terminus auth:whoami &> /dev/null; then
        print_message "$RED" "Error: Not authenticated with Terminus. Please run 'terminus auth:login'"
        exit 1
    fi
}

# Initialize CSV file
init_csv() {
    if [ "$EXPORT_CSV" = true ]; then
        echo "Site Name,Site ID,Upstream ID,Current Status,Action Taken,Notes" > "$CSV_FILE"
        print_message "$GREEN" "CSV export initialized: $CSV_FILE"
    fi
}

# Add entry to CSV
add_to_csv() {
    if [ "$EXPORT_CSV" = true ]; then
        echo "$1,$2,$3,$4,$5,$6" >> "$CSV_FILE"
    fi
}

# Verbose log function
verbose_log() {
    if [ "$VERBOSE" = true ]; then
        print_message "$BLUE" "[VERBOSE] $1"
    fi
}

# Main script execution
main() {
    parse_args "$@"
    validate_prerequisites
    
    print_message "$GREEN" "=========================================="
    print_message "$GREEN" "Pantheon Sites - Add Supporting Organization"
    print_message "$GREEN" "=========================================="
    echo ""
    print_message "$YELLOW" "Organization: $ORG_NAME"
    if [ -n "$UPSTREAM_ID" ]; then
        print_message "$YELLOW" "Upstream Filter: $UPSTREAM_ID"
    else
        print_message "$YELLOW" "Upstream Filter: None (processing all sites)"
    fi
    print_message "$YELLOW" "Supporting Org: $SUPPORTING_ORG"

    if [ "$DRY_RUN" = true ]; then
        print_message "$YELLOW" "Mode: DRY RUN (no changes will be made)"
    fi
    
    echo ""
    
    init_csv
    
    # Get all sites in the organization
    print_message "$YELLOW" "Fetching sites from organization..."
    verbose_log "Running: terminus org:site:list $ORG_NAME"
    
    SITES=$(terminus org:site:list "$ORG_NAME" --format=json 2>/dev/null)
    
    if [ $? -ne 0 ]; then
        print_message "$RED" "Error: Failed to fetch sites from organization '$ORG_NAME'"
        exit 1
    fi
    
    # Check if any sites were found
    SITE_COUNT=$(echo "$SITES" | jq '. | length')
    if [ "$SITE_COUNT" -eq 0 ]; then
        print_message "$YELLOW" "No sites found in organization '$ORG_NAME'"
        exit 0
    fi
    
    print_message "$GREEN" "Found $SITE_COUNT total sites in organization"
    echo ""
    
    # Arrays to track results
    declare -a MATCHED_SITES=()
    declare -a UPDATED_SITES=()
    declare -a FAILED_SITES=()
    declare -a ALREADY_HAS_SITES=()
    declare -a SKIPPED_SITES=()
    
    # Process each site
    print_message "$YELLOW" "Analyzing sites..."
    echo ""
    
    # Create progress counter
    CURRENT=0
    SITE_NAMES=$(echo "$SITES" | jq -r 'keys[]')
    
    while IFS= read -r SITE_NAME; do
        ((CURRENT++))
        echo -n "[$CURRENT/$SITE_COUNT] Checking $SITE_NAME... "
        
        # Get site info
        verbose_log "Fetching info for site: $SITE_NAME"
        SITE_INFO=$(terminus site:info "$SITE_NAME" --format=json 2>/dev/null)

        if [ $? -ne 0 ]; then
            echo "Failed to get info"
            FAILED_SITES+=("$SITE_NAME (couldn't get info)")
            add_to_csv "$SITE_NAME" "unknown" "unknown" "error" "skipped" "Failed to get site info"
            continue
        fi

        # Check if response is a JSON object (not a string like "frozen")
        SITE_TYPE=$(echo "$SITE_INFO" | jq -r 'type')
        if [ "$SITE_TYPE" != "object" ]; then
            echo "Site status: $SITE_INFO"
            verbose_log "Site returned non-object JSON ($SITE_TYPE): $SITE_INFO"
            FAILED_SITES+=("$SITE_NAME (site status: $SITE_INFO)")
            add_to_csv "$SITE_NAME" "unknown" "unknown" "$SITE_INFO" "skipped" "Site not accessible - status: $SITE_INFO"
            continue
        fi

        # Extract site ID and upstream ID
        SITE_ID=$(echo "$SITE_INFO" | jq -r '.id // "unknown"')
        SITE_UPSTREAM=$(echo "$SITE_INFO" | jq -r '.upstream.id // empty')

        # If upstream filter is specified, check if site matches
        if [ -n "$UPSTREAM_ID" ]; then
            if [ -z "$SITE_UPSTREAM" ]; then
                echo "No upstream"
                SKIPPED_SITES+=("$SITE_NAME (no upstream)")
                add_to_csv "$SITE_NAME" "$SITE_ID" "none" "no_upstream" "skipped" "Site has no upstream"
                continue
            fi

            if [ "$SITE_UPSTREAM" != "$UPSTREAM_ID" ]; then
                echo "Different upstream"
                verbose_log "Site upstream: $SITE_UPSTREAM (looking for: $UPSTREAM_ID)"
                SKIPPED_SITES+=("$SITE_NAME")
                add_to_csv "$SITE_NAME" "$SITE_ID" "$SITE_UPSTREAM" "different_upstream" "skipped" "Upstream doesn't match"
                continue
            fi

            echo "✓ Matches filter!"
        else
            echo "✓ Processing"
        fi

        MATCHED_SITES+=("$SITE_NAME")
        
        # Check existing organizations
        verbose_log "Checking existing organizations for $SITE_NAME"
        EXISTING_ORGS=$(terminus site:org:list "$SITE_NAME" --format=json 2>/dev/null)

        if [ $? -ne 0 ]; then
            echo "  └─ Failed to list orgs"
            FAILED_SITES+=("$SITE_NAME (couldn't list orgs)")
            add_to_csv "$SITE_NAME" "$SITE_ID" "$SITE_UPSTREAM" "error" "failed" "Couldn't list organizations"
            continue
        fi

        # Check if org list response is a JSON object
        ORGS_TYPE=$(echo "$EXISTING_ORGS" | jq -r 'type')
        if [ "$ORGS_TYPE" != "object" ]; then
            echo "  └─ Unexpected org list response"
            verbose_log "Org list returned non-object JSON ($ORGS_TYPE) for $SITE_NAME"
            FAILED_SITES+=("$SITE_NAME (unexpected org list response)")
            add_to_csv "$SITE_NAME" "$SITE_ID" "$SITE_UPSTREAM" "error" "failed" "Unexpected org list response type"
            continue
        fi

        # Check if supporting org already exists
        HAS_ORG=$(echo "$EXISTING_ORGS" | jq -r --arg org "$SUPPORTING_ORG" 'to_entries | .[] | select(.value.org_id == $org or .key == $org) | .key // empty' | head -n1)
        
        if [ -n "$HAS_ORG" ]; then
            echo "  └─ Already has supporting org"
            ALREADY_HAS_SITES+=("$SITE_NAME")
            add_to_csv "$SITE_NAME" "$SITE_ID" "$SITE_UPSTREAM" "has_org" "no_change" "Already has supporting organization"
        else
            if [ "$DRY_RUN" = true ]; then
                echo "  └─ Would add supporting org (dry run)"
                UPDATED_SITES+=("$SITE_NAME")
                add_to_csv "$SITE_NAME" "$SITE_ID" "$SITE_UPSTREAM" "needs_org" "would_add" "Would add supporting org (dry run)"
            else
                # Actually add the supporting organization
                verbose_log "Adding supporting org to $SITE_NAME"
                if terminus site:org:add "$SITE_NAME" "$SUPPORTING_ORG" 2>/dev/null; then
                    echo "  └─ ✓ Supporting org added"
                    UPDATED_SITES+=("$SITE_NAME")
                    add_to_csv "$SITE_NAME" "$SITE_ID" "$SITE_UPSTREAM" "needs_org" "added" "Successfully added supporting org"
                else
                    echo "  └─ ✗ Failed to add"
                    FAILED_SITES+=("$SITE_NAME")
                    add_to_csv "$SITE_NAME" "$SITE_ID" "$SITE_UPSTREAM" "needs_org" "failed" "Failed to add supporting org"
                fi
            fi
        fi
        
    done <<< "$SITE_NAMES"
    
    echo ""
    print_message "$GREEN" "=========================================="
    print_message "$GREEN" "Summary Report"
    print_message "$GREEN" "=========================================="
    echo ""
    
    # Print summary
    print_message "$GREEN" "Total sites in organization: $SITE_COUNT"
    if [ -n "$UPSTREAM_ID" ]; then
        print_message "$GREEN" "Sites matching upstream '$UPSTREAM_ID': ${#MATCHED_SITES[@]}"
    else
        print_message "$GREEN" "Sites processed: ${#MATCHED_SITES[@]}"
    fi
    echo ""
    
    if [ "$DRY_RUN" = true ]; then
        if [ ${#UPDATED_SITES[@]} -gt 0 ]; then
            print_message "$BLUE" "⚡ Would update: ${#UPDATED_SITES[@]} sites"
            for site in "${UPDATED_SITES[@]}"; do
                echo "  - $site"
            done
            echo ""
        fi
    else
        if [ ${#UPDATED_SITES[@]} -gt 0 ]; then
            print_message "$GREEN" "✓ Successfully updated: ${#UPDATED_SITES[@]} sites"
            for site in "${UPDATED_SITES[@]}"; do
                echo "  - $site"
            done
            echo ""
        fi
    fi
    
    if [ ${#ALREADY_HAS_SITES[@]} -gt 0 ]; then
        print_message "$YELLOW" "⊙ Already had supporting org: ${#ALREADY_HAS_SITES[@]} sites"
        if [ "$VERBOSE" = true ]; then
            for site in "${ALREADY_HAS_SITES[@]}"; do
                echo "  - $site"
            done
            echo ""
        fi
    fi
    
    if [ ${#FAILED_SITES[@]} -gt 0 ]; then
        print_message "$RED" "✗ Failed: ${#FAILED_SITES[@]} sites"
        for site in "${FAILED_SITES[@]}"; do
            echo "  - $site"
        done
        echo ""
    fi
    
    if [ ${#SKIPPED_SITES[@]} -gt 0 ] && [ "$VERBOSE" = true ]; then
        print_message "$BLUE" "⊘ Skipped (different upstream): ${#SKIPPED_SITES[@]} sites"
        echo ""
    fi
    
    if [ "$EXPORT_CSV" = true ]; then
        print_message "$GREEN" "CSV report exported to: $CSV_FILE"
    fi
    
    print_message "$GREEN" "Log file: $LOG_FILE"
    echo ""
    
    if [ "$DRY_RUN" = true ]; then
        print_message "$YELLOW" "This was a DRY RUN - no changes were made"
        print_message "$YELLOW" "Remove the --dry-run flag to apply changes"
    else
        print_message "$GREEN" "Operation complete!"
    fi
}

# Run the main function
main "$@"
