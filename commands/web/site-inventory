#!/bin/bash

## Description: Generate comprehensive inventory report of Pantheon organization sites
## Usage: site-inventory [flags] <org-name>
## Example: ddev site-inventory my-org\nddev site-inventory --csv inventory.csv my-org\nddev site-inventory --verbose my-org
## Flags: [{"Name":"csv","Shorthand":"c","Usage":"Export results to CSV file (default: stdout)","Type":"string"},{"Name":"verbose","Shorthand":"v","Usage":"Enable verbose output","Type":"bool"}]
## ExecRaw: true
#ddev-generated

# Configuration variables
ORG_NAME=""
EXPORT_CSV=false
CSV_FILE=""
VERBOSE=false
LOG_FILE="pantheon_site_inventory_$(date +%Y%m%d_%H%M%S).log"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}" >&2
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $message" >> "$LOG_FILE"
}

# Verbose log function
verbose_log() {
    if [ "$VERBOSE" = true ]; then
        print_message "$BLUE" "[VERBOSE] $1"
    fi
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -c|--csv)
                EXPORT_CSV=true
                CSV_FILE="$2"
                shift 2
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            *)
                if [ -z "$ORG_NAME" ]; then
                    ORG_NAME="$1"
                else
                    print_message "$RED" "Error: Too many arguments"
                    exit 1
                fi
                shift
                ;;
        esac
    done
}

# Validate prerequisites
validate_prerequisites() {
    if [ -z "$ORG_NAME" ]; then
        print_message "$RED" "Error: Missing required argument: <org-name>"
        exit 1
    fi

    if ! command -v terminus &> /dev/null; then
        print_message "$RED" "Error: Terminus is not installed or not in PATH"
        exit 1
    fi

    if ! command -v jq &> /dev/null; then
        print_message "$RED" "Error: jq is not installed. Please install jq to run this script"
        exit 1
    fi

    if ! terminus auth:whoami &> /dev/null; then
        print_message "$RED" "Error: Not authenticated with Terminus. Please run 'terminus auth:login'"
        exit 1
    fi
}

# Build a mapping of user ID to email from org:people:list
get_org_people_map() {
    verbose_log "Building organization people map..."

    local people_json=$(terminus org:people:list "$ORG_NAME" --format=json 2>/dev/null)

    if [ $? -ne 0 ] || [ -z "$people_json" ]; then
        verbose_log "Could not fetch org people list"
        echo "{}"
        return
    fi

    # Convert to a simple ID=email mapping
    # Handle both dict and list structures
    echo "$people_json" | jq -r '
        if type == "object" then
            [.[]]
        elif type == "array" then
            .
        else
            []
        end |
        map(select(type == "object")) |
        map({
            id: (.id // .user_id // .ID // ""),
            email: (.email // .Email // "")
        }) |
        map(select(.id != "" and .email != "")) |
        map("\(.id)=\(.email)") |
        .[]
    '
}

# Get canonical/custom domain for a site
get_canonical_domain() {
    local site_name=$1
    local env="${site_name}.live"

    verbose_log "Getting canonical domain for $site_name"

    # Try to get domain list
    local domains_json=$(terminus domain:list "$env" --format=json 2>/dev/null)

    if [ $? -eq 0 ] && [ -n "$domains_json" ]; then
        # Look for custom domain first
        local custom_domain=$(echo "$domains_json" | jq -r '
            if type == "object" then
                [.[]]
            elif type == "array" then
                .
            else
                []
            end |
            map(select(type == "object")) |
            map(select((.type // "" | ascii_downcase) == "custom")) |
            .[0] |
            (.id // .domain // .fqdn // .hostname // "")
        ')

        if [ -n "$custom_domain" ] && [ "$custom_domain" != "null" ]; then
            echo "$custom_domain"
            return
        fi
    fi

    # Fall back to platform domain
    local platform_domain=$(terminus env:info "$env" --field=domain 2>/dev/null)
    echo "${platform_domain:-}"
}

# Get WordPress version if applicable
get_wp_version() {
    local site_name=$1
    local framework=$2
    local env="${site_name}.live"

    framework=$(echo "$framework" | tr '[:upper:]' '[:lower:]')

    case "$framework" in
        wordpress|wordpress_network|wp|wp_network)
            verbose_log "Getting WordPress version for $site_name"
            local version=$(terminus wp "$env" -- core version 2>/dev/null)
            echo "${version:-}"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Get dashboard URL
get_dashboard_url() {
    local site_name=$1
    verbose_log "Getting dashboard URL for $site_name"
    local url=$(terminus dashboard:view "$site_name" --print 2>/dev/null)
    echo "${url:-}"
}

# Write CSV header
write_csv_header() {
    local output_file=$1
    if [ -n "$output_file" ]; then
        echo "Site Name,Upstream,WordPress Version,PHP Version,Public URL,Pantheon Dashboard URL,Plan,Status,Created date,Owner" > "$output_file"
    else
        echo "Site Name,Upstream,WordPress Version,PHP Version,Public URL,Pantheon Dashboard URL,Plan,Status,Created date,Owner"
    fi
}

# Write CSV row (escape commas in fields)
write_csv_row() {
    local output_file=$1
    shift
    local row=""

    for field in "$@"; do
        # Escape quotes and wrap in quotes if contains comma
        field=$(echo "$field" | sed 's/"/""/g')
        if [[ "$field" == *,* ]] || [[ "$field" == *\"* ]]; then
            field="\"$field\""
        fi

        if [ -z "$row" ]; then
            row="$field"
        else
            row="$row,$field"
        fi
    done

    if [ -n "$output_file" ]; then
        echo "$row" >> "$output_file"
    else
        echo "$row"
    fi
}

# Main script execution
main() {
    parse_args "$@"
    validate_prerequisites

    print_message "$GREEN" "=========================================="
    print_message "$GREEN" "Pantheon Site Inventory Report"
    print_message "$GREEN" "=========================================="
    echo "" >&2
    print_message "$YELLOW" "Organization: $ORG_NAME"
    if [ "$EXPORT_CSV" = true ]; then
        print_message "$YELLOW" "Output: $CSV_FILE"
    else
        print_message "$YELLOW" "Output: stdout"
    fi
    echo "" >&2

    # Build org people map
    print_message "$YELLOW" "Building organization member map..."
    declare -A OWNER_MAP
    while IFS='=' read -r id email; do
        if [ -n "$id" ] && [ -n "$email" ]; then
            OWNER_MAP["$id"]="$email"
        fi
    done < <(get_org_people_map)

    verbose_log "Found ${#OWNER_MAP[@]} organization members"

    # Get all sites in the organization
    print_message "$YELLOW" "Fetching sites from organization..."
    SITES=$(terminus org:site:list "$ORG_NAME" --format=json --fields=name,label 2>/dev/null)

    if [ $? -ne 0 ]; then
        print_message "$RED" "Error: Failed to fetch sites from organization '$ORG_NAME'"
        exit 1
    fi

    SITE_COUNT=$(echo "$SITES" | jq '. | length')
    if [ "$SITE_COUNT" -eq 0 ]; then
        print_message "$YELLOW" "No sites found in organization '$ORG_NAME'"
        exit 0
    fi

    print_message "$GREEN" "Found $SITE_COUNT sites. Gathering information..."
    echo "" >&2

    # Write CSV header
    if [ "$EXPORT_CSV" = true ]; then
        write_csv_header "$CSV_FILE"
    else
        write_csv_header
    fi

    # Process each site
    CURRENT=0
    SITE_NAMES=$(echo "$SITES" | jq -r 'if type == "object" then [.[]] else . end | .[] | select(type == "object") | .name // empty')

    while IFS= read -r SITE_NAME; do
        ((CURRENT++))
        echo -ne "[$CURRENT/$SITE_COUNT] Processing $SITE_NAME...\r" >&2

        # Get site info
        verbose_log "Fetching site info for: $SITE_NAME"
        SITE_INFO=$(terminus site:info "$SITE_NAME" --format=json 2>/dev/null)

        if [ $? -ne 0 ]; then
            verbose_log "Failed to get site info for $SITE_NAME"
            continue
        fi

        # Extract site fields
        FRAMEWORK=$(echo "$SITE_INFO" | jq -r '.framework // ""')
        PLAN=$(echo "$SITE_INFO" | jq -r '.plan_name // ""')
        CREATED=$(echo "$SITE_INFO" | jq -r '.created // ""')
        OWNER_ID=$(echo "$SITE_INFO" | jq -r '.owner // ""')
        UPSTREAM_LABEL=$(echo "$SITE_INFO" | jq -r '.upstream.label // .upstream_label // ""')
        UPSTREAM_UUID=$(echo "$SITE_INFO" | jq -r '.upstream.id // .upstream // ""')
        FROZEN=$(echo "$SITE_INFO" | jq -r '.frozen // ""')

        # Determine upstream (prefer label over UUID)
        if [ -n "$UPSTREAM_LABEL" ] && [ "$UPSTREAM_LABEL" != "null" ]; then
            UPSTREAM="$UPSTREAM_LABEL"
        else
            UPSTREAM="$UPSTREAM_UUID"
        fi

        # Determine status (Active or Frozen)
        FROZEN=$(echo "$FROZEN" | tr '[:upper:]' '[:lower:]')
        if [ "$FROZEN" = "1" ] || [ "$FROZEN" = "true" ] || [ "$FROZEN" = "yes" ]; then
            STATUS="Frozen"
        else
            STATUS="Active"
        fi

        # Get environment info for PHP version
        verbose_log "Fetching env info for: $SITE_NAME"
        ENV_INFO=$(terminus env:info "${SITE_NAME}.live" --format=json 2>/dev/null)
        PHP_VERSION=$(echo "$ENV_INFO" | jq -r '.php_version // ""')

        # Get canonical domain
        PUBLIC_URL_RAW=$(get_canonical_domain "$SITE_NAME")
        if [ -n "$PUBLIC_URL_RAW" ] && [[ ! "$PUBLIC_URL_RAW" =~ ^https?:// ]]; then
            PUBLIC_URL="https://${PUBLIC_URL_RAW}"
        else
            PUBLIC_URL="$PUBLIC_URL_RAW"
        fi

        # Get dashboard URL
        DASH_URL=$(get_dashboard_url "$SITE_NAME")

        # Get WordPress version if applicable
        WP_VERSION=$(get_wp_version "$SITE_NAME" "$FRAMEWORK")

        # Look up owner email
        OWNER_EMAIL="${OWNER_MAP[$OWNER_ID]:-$OWNER_ID}"

        # Write row
        if [ "$EXPORT_CSV" = true ]; then
            write_csv_row "$CSV_FILE" "$SITE_NAME" "$UPSTREAM" "$WP_VERSION" "$PHP_VERSION" "$PUBLIC_URL" "$DASH_URL" "$PLAN" "$STATUS" "$CREATED" "$OWNER_EMAIL"
        else
            write_csv_row "" "$SITE_NAME" "$UPSTREAM" "$WP_VERSION" "$PHP_VERSION" "$PUBLIC_URL" "$DASH_URL" "$PLAN" "$STATUS" "$CREATED" "$OWNER_EMAIL"
        fi

    done <<< "$SITE_NAMES"

    echo "" >&2
    echo "" >&2
    print_message "$GREEN" "=========================================="
    print_message "$GREEN" "Report Complete"
    print_message "$GREEN" "=========================================="
    echo "" >&2
    print_message "$GREEN" "Processed $CURRENT sites"

    if [ "$EXPORT_CSV" = true ]; then
        print_message "$GREEN" "CSV report saved to: $CSV_FILE"
        echo "" >&2
        print_message "$YELLOW" "View the report: cat $CSV_FILE"
    fi

    print_message "$GREEN" "Log file: $LOG_FILE"
    echo "" >&2
}

# Run the main function
main "$@"
